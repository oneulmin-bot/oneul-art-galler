<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>(ì‚¬)ì˜¤ëŠ˜ì€ ë¯¸ìˆ ì‘í’ˆ ì¸í„°ë™í‹°ë¸Œ ì•„ì¹´ì´ë¸Œ</title>
    <!-- Tailwind CSS CDN -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Chart.js CDN -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <!-- Firebase SDKs -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInWithCustomToken, signInAnonymously, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, doc, setDoc, getDoc, collection, query, onSnapshot, addDoc, updateDoc, deleteDoc } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // Firebase Configuration (Provided by environment)
        const firebaseConfig = JSON.parse(__firebase_config);
        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';

        // Global State
        window.appState = {
            user: null,
            artworks: [],
            currentView: 'gallery', // 'gallery' or 'admin'
            filter: { search: '', year: 'all' }
        };

        // Charts instances
        let materialChart = null;
        let yearChart = null;

        // Initialize Auth
        const initAuth = async () => {
            if (typeof __initial_auth_token !== 'undefined' && __initial_auth_token) {
                await signInWithCustomToken(auth, __initial_auth_token);
            } else {
                await signInAnonymously(auth);
            }
        };

        // Firebase Data Sync
        onAuthStateChanged(auth, (user) => {
            window.appState.user = user;
            if (user) {
                const artworksCol = collection(db, 'artifacts', appId, 'public', 'data', 'artworks');
                onSnapshot(artworksCol, (snapshot) => {
                    const data = [];
                    snapshot.forEach(doc => data.push({ id: doc.id, ...doc.data() }));
                    window.appState.artworks = data;
                    updateUI();
                }, (error) => console.error("Firestore Error:", error));
            }
        });

        // Helper: Convert Google Drive Link
        const getDirectImageUrl = (url) => {
            if (!url) return "https://images.unsplash.com/photo-1579783902614-a3fb3927b6a5?auto=format&fit=crop&w=800&q=80";
            try {
                const regExp = /\/d\/([^\/]+)\//;
                const match = url.match(regExp);
                if (match && match[1]) return `https://drive.google.com/uc?id=${match[1]}`;
                const urlObj = new URL(url);
                const id = urlObj.searchParams.get('id');
                if (id) return `https://drive.google.com/uc?id=${id}`;
            } catch (e) { return url; }
            return url;
        };

        // Actions
        window.toggleView = (view) => {
            window.appState.currentView = view;
            updateUI();
        };

        window.addArtwork = async (e) => {
            e.preventDefault();
            if (!window.appState.user) return;
            const formData = new FormData(e.target);
            const newArt = Object.fromEntries(formData.entries());
            
            try {
                await addDoc(collection(db, 'artifacts', appId, 'public', 'data', 'artworks'), {
                    ...newArt,
                    createdAt: new Date().toISOString()
                });
                e.target.reset();
                showNotification("ì‘í’ˆì´ ì„±ê³µì ìœ¼ë¡œ ë“±ë¡ë˜ì—ˆìŠµë‹ˆë‹¤.");
            } catch (err) {
                console.error(err);
                showNotification("ë“±ë¡ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.", true);
            }
        };

        window.deleteArtwork = async (id) => {
            if (!confirm("ì •ë§ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?")) return;
            try {
                await deleteDoc(doc(db, 'artifacts', appId, 'public', 'data', 'artworks', id));
                showNotification("ì‘í’ˆì´ ì‚­ì œë˜ì—ˆìŠµë‹ˆë‹¤.");
            } catch (err) {
                showNotification("ì‚­ì œ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.", true);
            }
        };

        const showNotification = (msg, isError = false) => {
            const toast = document.getElementById('toast');
            toast.textContent = msg;
            toast.className = `fixed bottom-10 left-1/2 -translate-x-1/2 px-6 py-3 rounded-full text-white font-bold transition-all z-[200] ${isError ? 'bg-red-500' : 'bg-blue-600'}`;
            toast.style.display = 'block';
            setTimeout(() => { toast.style.display = 'none'; }, 3000);
        };

        // UI Updates
        const updateUI = () => {
            const gallerySection = document.getElementById('gallery-view');
            const adminSection = document.getElementById('admin-view');
            const navLinks = document.querySelectorAll('.nav-link');

            // View Toggle
            if (window.appState.currentView === 'admin') {
                gallerySection.classList.add('hidden');
                adminSection.classList.remove('hidden');
            } else {
                gallerySection.classList.remove('hidden');
                adminSection.classList.add('hidden');
            }

            // Stats
            document.getElementById('total-count').textContent = window.appState.artworks.length;
            
            // Render Lists
            renderGallery();
            renderAdminTable();
            renderCharts();
        };

        const renderGallery = () => {
            const grid = document.getElementById('artGrid');
            const filtered = window.appState.artworks.filter(item => {
                const matchesSearch = (item.title || '').toLowerCase().includes(window.appState.filter.search.toLowerCase()) || 
                                     (item.artist || '').toLowerCase().includes(window.appState.filter.search.toLowerCase());
                const matchesYear = window.appState.filter.year === 'all' || item.year === window.appState.filter.year;
                return matchesSearch && matchesYear;
            });

            if (filtered.length === 0) {
                grid.innerHTML = '<div class="col-span-full py-20 text-center text-slate-300">í‘œì‹œí•  ì‘í’ˆì´ ì—†ìŠµë‹ˆë‹¤.</div>';
                return;
            }

            grid.innerHTML = filtered.map(item => `
                <div class="artwork-card group bg-white rounded-3xl overflow-hidden shadow-sm hover:shadow-2xl transition-all duration-500 cursor-pointer border border-slate-100 flex flex-col transform hover:-translate-y-2"
                     onclick="openModal('${item.id}')">
                    <div class="aspect-[4/5] w-full bg-slate-50 overflow-hidden relative">
                        <img src="${getDirectImageUrl(item.imageUrl)}" 
                             class="w-full h-full object-cover transition-transform duration-700 group-hover:scale-110"
                             onerror="this.src='https://images.unsplash.com/photo-1579783902614-a3fb3927b6a5?auto=format&fit=crop&w=500&h=600'">
                        <div class="absolute top-4 left-4">
                            <span class="px-3 py-1 bg-white/90 backdrop-blur-md text-[10px] font-black text-blue-600 rounded-full shadow-sm tracking-tighter uppercase italic">
                                ${item.year} Series
                            </span>
                        </div>
                    </div>
                    <div class="p-6">
                        <h3 class="font-black text-lg text-slate-900 truncate mb-1">${item.title}</h3>
                        <p class="text-sm text-slate-500 font-medium">ğŸ‘¤ ${item.artist}</p>
                    </div>
                </div>
            `).join('');
        };

        const renderAdminTable = () => {
            const tbody = document.getElementById('adminTableBody');
            tbody.innerHTML = window.appState.artworks.map(item => `
                <tr class="border-b border-slate-50 hover:bg-slate-50 transition-colors">
                    <td class="py-4 px-4 font-bold text-sm text-slate-400">${item.year}</td>
                    <td class="py-4 px-4 font-bold text-slate-900">${item.title}</td>
                    <td class="py-4 px-4 text-slate-600">${item.artist}</td>
                    <td class="py-4 px-4">
                        <button onclick="deleteArtwork('${item.id}')" class="text-red-400 hover:text-red-600 font-bold text-xs uppercase tracking-tighter">Delete</button>
                    </td>
                </tr>
            `).join('');
        };

        const renderCharts = () => {
            const data = window.appState.artworks;
            if (data.length === 0) return;

            const materialMap = {};
            const yearMap = {};

            data.forEach(item => {
                const m = (item.material || 'ê¸°íƒ€').split(' ')[0];
                materialMap[m] = (materialMap[m] || 0) + 1;
                yearMap[item.year] = (yearMap[item.year] || 0) + 1;
            });

            if (materialChart) materialChart.destroy();
            if (yearChart) yearChart.destroy();

            materialChart = new Chart(document.getElementById('materialChart').getContext('2d'), {
                type: 'bar',
                data: {
                    labels: Object.keys(materialMap),
                    datasets: [{ data: Object.values(materialMap), backgroundColor: '#2563eb', borderRadius: 8 }]
                },
                options: { indexAxis: 'y', plugins: { legend: { display: false } }, maintainAspectRatio: false }
            });

            yearChart = new Chart(document.getElementById('yearChart').getContext('2d'), {
                type: 'doughnut',
                data: {
                    labels: Object.keys(yearMap),
                    datasets: [{ data: Object.values(yearMap), backgroundColor: ['#2563eb', '#cbd5e1', '#94a3b8'] }]
                },
                options: { cutout: '70%', maintainAspectRatio: false }
            });
        };

        window.openModal = (id) => {
            const item = window.appState.artworks.find(d => d.id === id);
            if (!item) return;
            document.getElementById('modalImg').src = getDirectImageUrl(item.imageUrl);
            document.getElementById('modalTitle').textContent = item.title;
            document.getElementById('modalArtist').textContent = item.artist;
            document.getElementById('modalSize').textContent = item.size;
            document.getElementById('modalMaterial').textContent = item.material;
            document.getElementById('modalDescription').textContent = item.description;
            document.getElementById('modalBio').textContent = item.artistBio;
            document.getElementById('detailModal').classList.remove('hidden');
            document.getElementById('detailModal').classList.add('flex');
        };

        window.closeModal = () => {
            document.getElementById('detailModal').classList.add('hidden');
            document.getElementById('detailModal').classList.remove('flex');
        };

        window.onload = () => {
            initAuth();
            document.getElementById('searchInput').oninput = (e) => {
                window.appState.filter.search = e.target.value;
                renderGallery();
            };
            document.getElementById('yearFilter').onchange = (e) => {
                window.appState.filter.year = e.target.value;
                renderGallery();
            };
        };
    </script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Noto+Sans+KR:wght@300;400;500;700;900&display=swap');
        body { font-family: 'Noto Sans KR', sans-serif; background-color: #fdfbf7; }
        .chart-container { position: relative; width: 100%; height: 250px; }
        .custom-scrollbar::-webkit-scrollbar { width: 4px; }
        .custom-scrollbar::-webkit-scrollbar-thumb { background: #cbd5e1; border-radius: 10px; }
    </style>
</head>
<body class="text-slate-800 selection:bg-blue-100 overflow-x-hidden">

<!-- Chosen Palette: Warm Ivory & Professional Slate Blue -->
<!-- Application Structure Plan: 
    1. Navigation: ê°¤ëŸ¬ë¦¬ì™€ ê´€ë¦¬ì ëª¨ë“œë¥¼ ì „í™˜í•˜ëŠ” íƒ­.
    2. Gallery View (Main): ì „ì²´ ì‘í’ˆ íƒìƒ‰, ê²€ìƒ‰, ì‹œê°í™” ëŒ€ì‹œë³´ë“œ.
    3. Admin View (Management): êµ¬ê¸€ ì‹œíŠ¸ì²˜ëŸ¼ ë°ì´í„°ë¥¼ í–‰ í˜•íƒœë¡œ ê´€ë¦¬í•˜ê³  ì‹¤ì‹œê°„ ì¶”ê°€/ì‚­ì œ.
    4. Cloud Sync: Firestoreë¥¼ ì‚¬ìš©í•˜ì—¬ ë°ì´í„°ê°€ ìƒˆë¡œê³ ì¹¨ í›„ì—ë„ ìœ ì§€ë˜ë„ë¡ ì„¤ê³„.
-->

<div id="app" class="min-h-screen flex flex-col">
    <!-- Navigation -->
    <nav class="bg-white/90 backdrop-blur-md border-b border-orange-100 sticky top-0 z-50">
        <div class="max-w-7xl mx-auto px-6 py-4 flex justify-between items-center">
            <div class="flex items-center gap-3 cursor-pointer" onclick="toggleView('gallery')">
                <div class="w-8 h-8 bg-blue-600 rounded-lg flex items-center justify-center text-white font-black">A</div>
                <span class="font-black text-xl tracking-tighter">ART ARCHIVE</span>
            </div>
            <div class="flex gap-4 md:gap-8">
                <button onclick="toggleView('gallery')" class="text-sm font-bold text-slate-500 hover:text-blue-600 transition-colors">ê°¤ëŸ¬ë¦¬</button>
                <button onclick="toggleView('admin')" class="px-4 py-2 bg-slate-900 text-white text-xs font-black rounded-full hover:bg-blue-600 transition-all">ê´€ë¦¬ì ëª¨ë“œ</button>
            </div>
        </div>
    </nav>

    <!-- TOAST -->
    <div id="toast" class="hidden"></div>

    <!-- GALLERY VIEW -->
    <div id="gallery-view">
        <header class="bg-white py-16 border-b border-slate-100">
            <div class="max-w-7xl mx-auto px-6 text-center">
                <h1 class="text-4xl md:text-5xl font-black text-slate-900 mb-4 tracking-tight">ì²­ë…„ ì˜ˆìˆ ê°€ <span class="text-blue-600 italic">ë””ì§€í„¸ ì•„ì¹´ì´ë¸Œ</span></h1>
                <p class="text-slate-500 font-medium">í˜„ì¬ ì´ <span id="total-count" class="text-blue-600 font-black">0</span>ì ì˜ ì‘í’ˆì´ ë“±ë¡ë˜ì–´ ìˆìŠµë‹ˆë‹¤.</p>
            </div>
        </header>

        <section class="py-12 bg-slate-50 border-b border-slate-200">
            <div class="max-w-7xl mx-auto px-6 grid grid-cols-1 md:grid-cols-2 gap-8">
                <div class="bg-white p-6 rounded-3xl shadow-sm border border-slate-100">
                    <h3 class="text-xs font-black text-slate-300 uppercase tracking-widest mb-4">Material Stats</h3>
                    <div class="chart-container"><canvas id="materialChart"></canvas></div>
                </div>
                <div class="bg-white p-6 rounded-3xl shadow-sm border border-slate-100">
                    <h3 class="text-xs font-black text-slate-300 uppercase tracking-widest mb-4">Series Distribution</h3>
                    <div class="chart-container"><canvas id="yearChart"></canvas></div>
                </div>
            </div>
        </section>

        <section class="py-16 max-w-7xl mx-auto px-6">
            <div class="flex flex-col md:flex-row gap-4 mb-12 items-center justify-between">
                <div class="relative w-full md:w-96">
                    <input type="text" id="searchInput" placeholder="ì‘ê°€ ë˜ëŠ” ì œëª©ìœ¼ë¡œ ê²€ìƒ‰..." class="w-full pl-10 pr-4 py-3 bg-white border border-slate-200 rounded-2xl outline-none focus:ring-4 focus:ring-blue-500/10 transition-all">
                    <span class="absolute left-4 top-1/2 -translate-y-1/2">ğŸ”</span>
                </div>
                <select id="yearFilter" class="w-full md:w-40 px-4 py-3 bg-white border border-slate-200 rounded-2xl font-bold appearance-none cursor-pointer outline-none">
                    <option value="all">ì „ì²´ ì—°ë„</option>
                    <option value="2025">2025ë…„</option>
                    <option value="2024">2024ë…„</option>
                </select>
            </div>
            <div id="artGrid" class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 xl:grid-cols-4 gap-8"></div>
        </section>
    </div>

    <!-- ADMIN VIEW -->
    <div id="admin-view" class="hidden py-16">
        <div class="max-w-7xl mx-auto px-6">
            <div class="grid lg:grid-cols-3 gap-12">
                <!-- Add Form -->
                <div class="lg:col-span-1">
                    <div class="bg-white p-8 rounded-[40px] shadow-xl border border-blue-50 sticky top-24">
                        <h2 class="text-2xl font-black mb-6">ìƒˆ ì‘í’ˆ ë“±ë¡ ğŸ¨</h2>
                        <form onsubmit="addArtwork(event)" class="space-y-4">
                            <input name="title" placeholder="ì‘í’ˆ ì œëª©" required class="w-full px-4 py-3 bg-slate-50 border-none rounded-xl focus:ring-2 focus:ring-blue-500 outline-none">
                            <input name="artist" placeholder="ì‘ê°€ ì´ë¦„" required class="w-full px-4 py-3 bg-slate-50 border-none rounded-xl focus:ring-2 focus:ring-blue-500 outline-none">
                            <div class="grid grid-cols-2 gap-3">
                                <input name="year" placeholder="ì—°ë„ (ì˜ˆ: 2025)" required class="px-4 py-3 bg-slate-50 border-none rounded-xl focus:ring-2 focus:ring-blue-500 outline-none">
                                <input name="size" placeholder="í¬ê¸° (ì˜ˆ: 15x15)" class="px-4 py-3 bg-slate-50 border-none rounded-xl focus:ring-2 focus:ring-blue-500 outline-none">
                            </div>
                            <input name="material" placeholder="ì¬ë£Œ ì •ë³´" class="w-full px-4 py-3 bg-slate-50 border-none rounded-xl focus:ring-2 focus:ring-blue-500 outline-none">
                            <textarea name="description" placeholder="ì‘í’ˆ ì„¤ëª…" rows="3" class="w-full px-4 py-3 bg-slate-50 border-none rounded-xl focus:ring-2 focus:ring-blue-500 outline-none"></textarea>
                            <textarea name="artistBio" placeholder="ì‘ê°€ ì†Œê°œ" rows="2" class="w-full px-4 py-3 bg-slate-50 border-none rounded-xl focus:ring-2 focus:ring-blue-500 outline-none"></textarea>
                            <input name="imageUrl" placeholder="ì´ë¯¸ì§€ ë§í¬ (êµ¬ê¸€ ë“œë¼ì´ë¸Œ ë“±)" class="w-full px-4 py-3 bg-slate-50 border-none rounded-xl focus:ring-2 focus:ring-blue-500 outline-none">
                            <button type="submit" class="w-full py-4 bg-blue-600 text-white font-black rounded-2xl hover:bg-blue-700 transition-all shadow-lg shadow-blue-500/20">ë°ì´í„°ë² ì´ìŠ¤ì— ì €ì¥</button>
                        </form>
                    </div>
                </div>
                <!-- Data Table -->
                <div class="lg:col-span-2">
                    <div class="bg-white rounded-[40px] shadow-sm border border-slate-100 overflow-hidden">
                        <div class="p-8 border-b border-slate-100 flex justify-between items-center">
                            <h2 class="text-xl font-black">ì•„ì¹´ì´ë¸Œ ë°ì´í„° ëª©ë¡ ğŸ“</h2>
                            <span class="text-xs font-bold text-slate-400">Total Rows: <span id="admin-count">0</span></span>
                        </div>
                        <div class="overflow-x-auto">
                            <table class="w-full text-left">
                                <thead class="bg-slate-50 text-[10px] font-black uppercase text-slate-400">
                                    <tr>
                                        <th class="py-4 px-4">Year</th>
                                        <th class="py-4 px-4">Title</th>
                                        <th class="py-4 px-4">Artist</th>
                                        <th class="py-4 px-4">Action</th>
                                    </tr>
                                </thead>
                                <tbody id="adminTableBody" class="text-sm"></tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- MODAL -->
    <div id="detailModal" class="fixed inset-0 z-[200] hidden items-center justify-center p-4 bg-slate-950/90 backdrop-blur-xl transition-all">
        <div class="bg-white w-full max-w-6xl max-h-[90vh] rounded-[40px] overflow-hidden shadow-2xl flex flex-col md:flex-row relative">
            <button onclick="closeModal()" class="absolute top-6 right-6 z-10 p-4 bg-white/20 hover:bg-white/40 text-slate-600 rounded-full transition-all">âœ•</button>
            <div class="md:w-3/5 bg-slate-50 flex items-center justify-center p-6 border-r border-slate-100">
                <img id="modalImg" src="" class="max-w-full max-h-[70vh] object-contain shadow-2xl rounded-sm">
            </div>
            <div class="md:w-2/5 p-8 md:p-12 overflow-y-auto bg-white custom-scrollbar">
                <h2 id="modalTitle" class="text-3xl font-black mb-2"></h2>
                <div class="flex items-center gap-2 mb-8"><div class="w-8 h-8 rounded-full bg-blue-50 flex items-center justify-center text-blue-500">ğŸ‘¤</div><p id="modalArtist" class="font-bold text-lg text-slate-700"></p></div>
                <div class="space-y-8">
                    <div>
                        <h4 class="text-[10px] font-black text-blue-600 uppercase tracking-widest mb-4 italic">Specifications</h4>
                        <div class="grid grid-cols-2 gap-2 text-sm">
                            <div class="bg-slate-50 p-4 rounded-2xl"><span class="text-[10px] text-slate-400 block font-bold">SIZE</span><span id="modalSize" class="font-bold"></span></div>
                            <div class="bg-slate-50 p-4 rounded-2xl"><span class="text-[10px] text-slate-400 block font-bold">MEDIA</span><span id="modalMaterial" class="font-bold"></span></div>
                        </div>
                    </div>
                    <p id="modalDescription" class="text-slate-600 leading-relaxed bg-slate-50 p-6 rounded-3xl text-sm"></p>
                    <div>
                        <h4 class="text-[10px] font-black text-blue-600 uppercase tracking-widest mb-4 italic">Artist Statement</h4>
                        <p id="modalBio" class="text-slate-400 text-sm italic leading-relaxed border-l-4 border-blue-100 pl-4"></p>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
</body>
</html>